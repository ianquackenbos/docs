---
title: Kubernetes Deployment
description: "Deploy Shardly on Kubernetes"
---

## Overview

This guide covers deploying Shardly on Kubernetes for production environments with high availability and scalability.

## Prerequisites

- Kubernetes 1.25+
- Helm 3.0+
- kubectl configured for your cluster
- Ingress controller (nginx, traefik, etc.)
- Persistent volume provisioner

## Helm Chart

### Add Repository

```bash
helm repo add shardly https://charts.shardly.io
helm repo update
```

### Install

```bash
helm install shardly shardly/shardly \
  --namespace shardly \
  --create-namespace \
  --values values.yaml
```

### values.yaml

```yaml
# Global settings
global:
  domain: shardly.yourcompany.com

# Backend API
backend:
  replicaCount: 3
  image:
    repository: shardly/backend
    tag: latest
  resources:
    requests:
      cpu: 500m
      memory: 512Mi
    limits:
      cpu: 2000m
      memory: 2Gi
  env:
    - name: DATABASE_URL
      valueFrom:
        secretKeyRef:
          name: shardly-secrets
          key: database-url
    - name: REDIS_URL
      valueFrom:
        secretKeyRef:
          name: shardly-secrets
          key: redis-url

# Frontend
frontend:
  replicaCount: 2
  image:
    repository: shardly/frontend
    tag: latest
  resources:
    requests:
      cpu: 200m
      memory: 256Mi
    limits:
      cpu: 1000m
      memory: 512Mi

# Celery Workers
worker:
  replicaCount: 2
  autoscaling:
    enabled: true
    minReplicas: 2
    maxReplicas: 10
    targetCPUUtilizationPercentage: 70

# Celery Beat
beat:
  enabled: true

# PostgreSQL (optional, use external for production)
postgresql:
  enabled: false  # Use external database
  
# Redis (optional, use external for production)
redis:
  enabled: false  # Use external Redis

# Ingress
ingress:
  enabled: true
  className: nginx
  annotations:
    cert-manager.io/cluster-issuer: letsencrypt-prod
  hosts:
    - host: shardly.yourcompany.com
      paths:
        - path: /
          pathType: Prefix
  tls:
    - secretName: shardly-tls
      hosts:
        - shardly.yourcompany.com
```

## Kubernetes Manifests

For manual deployment without Helm:

### Namespace

```yaml namespace.yaml
apiVersion: v1
kind: Namespace
metadata:
  name: shardly
```

### Secrets

```yaml secrets.yaml
apiVersion: v1
kind: Secret
metadata:
  name: shardly-secrets
  namespace: shardly
type: Opaque
stringData:
  database-url: "postgresql://user:pass@host:5432/shardly"
  redis-url: "redis://host:6379/0"
  encryption-key: "your-fernet-key"
  clerk-secret-key: "sk_live_xxx"
  clerk-webhook-secret: "whsec_xxx"
  anthropic-api-key: "sk-ant-xxx"
```

### ConfigMap

```yaml configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: shardly-config
  namespace: shardly
data:
  APP_NAME: "Shardly"
  DEBUG: "false"
  CORS_ORIGINS: '["https://shardly.yourcompany.com"]'
```

### Backend Deployment

```yaml backend-deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: backend
  namespace: shardly
spec:
  replicas: 3
  selector:
    matchLabels:
      app: backend
  template:
    metadata:
      labels:
        app: backend
    spec:
      containers:
        - name: backend
          image: shardly/backend:latest
          ports:
            - containerPort: 8000
          envFrom:
            - configMapRef:
                name: shardly-config
            - secretRef:
                name: shardly-secrets
          resources:
            requests:
              cpu: 500m
              memory: 512Mi
            limits:
              cpu: 2000m
              memory: 2Gi
          livenessProbe:
            httpGet:
              path: /health
              port: 8000
            initialDelaySeconds: 30
            periodSeconds: 10
          readinessProbe:
            httpGet:
              path: /health
              port: 8000
            initialDelaySeconds: 5
            periodSeconds: 5
---
apiVersion: v1
kind: Service
metadata:
  name: backend
  namespace: shardly
spec:
  selector:
    app: backend
  ports:
    - port: 8000
      targetPort: 8000
```

### Frontend Deployment

```yaml frontend-deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: frontend
  namespace: shardly
spec:
  replicas: 2
  selector:
    matchLabels:
      app: frontend
  template:
    metadata:
      labels:
        app: frontend
    spec:
      containers:
        - name: frontend
          image: shardly/frontend:latest
          ports:
            - containerPort: 3000
          env:
            - name: NEXT_PUBLIC_API_URL
              value: "https://api.shardly.yourcompany.com"
          envFrom:
            - secretRef:
                name: shardly-secrets
          resources:
            requests:
              cpu: 200m
              memory: 256Mi
            limits:
              cpu: 1000m
              memory: 512Mi
---
apiVersion: v1
kind: Service
metadata:
  name: frontend
  namespace: shardly
spec:
  selector:
    app: frontend
  ports:
    - port: 3000
      targetPort: 3000
```

### Worker Deployment

```yaml worker-deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: worker
  namespace: shardly
spec:
  replicas: 2
  selector:
    matchLabels:
      app: worker
  template:
    metadata:
      labels:
        app: worker
    spec:
      containers:
        - name: worker
          image: shardly/backend:latest
          command: ["celery", "-A", "app.tasks.celery_app", "worker", "-l", "info"]
          envFrom:
            - configMapRef:
                name: shardly-config
            - secretRef:
                name: shardly-secrets
          resources:
            requests:
              cpu: 250m
              memory: 256Mi
            limits:
              cpu: 1000m
              memory: 1Gi
```

### HorizontalPodAutoscaler

```yaml hpa.yaml
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: worker-hpa
  namespace: shardly
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: worker
  minReplicas: 2
  maxReplicas: 10
  metrics:
    - type: Resource
      resource:
        name: cpu
        target:
          type: Utilization
          averageUtilization: 70
```

### Ingress

```yaml ingress.yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: shardly-ingress
  namespace: shardly
  annotations:
    kubernetes.io/ingress.class: nginx
    cert-manager.io/cluster-issuer: letsencrypt-prod
    nginx.ingress.kubernetes.io/proxy-body-size: "10m"
spec:
  tls:
    - hosts:
        - shardly.yourcompany.com
        - api.shardly.yourcompany.com
      secretName: shardly-tls
  rules:
    - host: shardly.yourcompany.com
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: frontend
                port:
                  number: 3000
    - host: api.shardly.yourcompany.com
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: backend
                port:
                  number: 8000
```

## Database Migration Job

```yaml migration-job.yaml
apiVersion: batch/v1
kind: Job
metadata:
  name: db-migration
  namespace: shardly
spec:
  template:
    spec:
      containers:
        - name: migration
          image: shardly/backend:latest
          command: ["alembic", "upgrade", "head"]
          envFrom:
            - secretRef:
                name: shardly-secrets
      restartPolicy: Never
  backoffLimit: 3
```

Run migrations:

```bash
kubectl apply -f migration-job.yaml
kubectl logs -f job/db-migration -n shardly
```

## Monitoring

### ServiceMonitor (Prometheus)

```yaml servicemonitor.yaml
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: shardly
  namespace: shardly
spec:
  selector:
    matchLabels:
      app: backend
  endpoints:
    - port: http
      path: /metrics
      interval: 30s
```

### PodDisruptionBudget

```yaml pdb.yaml
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: backend-pdb
  namespace: shardly
spec:
  minAvailable: 2
  selector:
    matchLabels:
      app: backend
```

## Troubleshooting

### Check Pod Status

```bash
kubectl get pods -n shardly
kubectl describe pod <pod-name> -n shardly
```

### View Logs

```bash
kubectl logs -f deployment/backend -n shardly
kubectl logs -f deployment/worker -n shardly
```

### Shell Access

```bash
kubectl exec -it deployment/backend -n shardly -- /bin/bash
```

### Check Ingress

```bash
kubectl describe ingress shardly-ingress -n shardly
```

## Upgrades

### Helm Upgrade

```bash
helm upgrade shardly shardly/shardly \
  --namespace shardly \
  --values values.yaml
```

### Rolling Update

```bash
kubectl set image deployment/backend backend=shardly/backend:v2.0.0 -n shardly
kubectl rollout status deployment/backend -n shardly
```

### Rollback

```bash
kubectl rollout undo deployment/backend -n shardly
# Or with Helm
helm rollback shardly -n shardly
```

